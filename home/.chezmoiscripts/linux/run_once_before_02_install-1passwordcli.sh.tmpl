#!/usr/bin/env bash

# Import formatting library
source "{{ .chezmoi.sourceDir }}/utils-linux/formatting.sh"

set -eufo pipefail

print_header "1Password CLI Installation" "Installing 1Password CLI" "$ICON_INSTALL"

# Set total steps for progress tracking
set_total_steps 4

# Step 1: Check if already installed
print_step 1 "1Password CLI Availability Check"
if command -v op &>/dev/null; then
  print_success "1Password CLI is already installed"
  print_footer "1Password CLI Installation" "already installed"
  exit 0
fi

# Step 2: Get latest version
print_step 2 "Getting Latest Version"
print_action "Fetching" "latest version information" "$ICON_UPDATE"
ARCH="amd64"
OP_VERSION="v$(curl https://app-updates.agilebits.com/check/1/0/CLI2/en/2.0.0/N -s | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+')"
print_success "Latest version: $OP_VERSION"

# Step 3: Download and install
print_step 3 "Download and Install"
print_action "Downloading" "1Password CLI $OP_VERSION" "$ICON_DOWNLOAD"

# Create temporary directory for download
TEMP_DIR=$(mktemp -d)
cd "$TEMP_DIR"

curl -sSfo op.zip \
  https://cache.agilebits.com/dist/1P/op2/pkg/"$OP_VERSION"/op_linux_"$ARCH"_"$OP_VERSION".zip

print_action "Installing" "1Password CLI to /usr/local/bin" "$ICON_INSTALL"
sudo unzip -od /usr/local/bin/ op.zip

# Clean up
cd - > /dev/null
rm -rf "$TEMP_DIR"

# Step 4: Verify installation
print_step 4 "Verification"
print_action "Verifying" "1Password CLI installation" "$ICON_CHECK"

if command -v op &>/dev/null; then
  VERSION=$(op --version)
  print_success "1Password CLI installed successfully: $VERSION"
else
  print_error "1Password CLI installation failed"
  exit 1
fi

print_success "1Password CLI installation completed successfully!"
print_footer "1Password CLI Installation" "completed"
