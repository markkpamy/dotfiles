#!/bin/bash

# Import formatting library
source "{{ .chezmoi.sourceDir }}/utils-linux/formatting.sh"

{{- if and .pkgs.python.linux.pipx .installPythonPackages }}

print_header "Python Pipx Package Installation" "Installing Python packages via pipx" "$ICON_PYTHON"

# Set total steps for progress tracking
set_total_steps 3

# Step 1: Environment Check
print_step 1 "Environment Check"

# Check if pipx is installed
if ! command -v pipx &> /dev/null; then
    print_error "pipx is not installed. Please install pipx via pip first (pip3 install --user pipx)."
    print_footer "Python Pipx Package Installation" "failed"
    exit 1
fi

print_success "pipx is available"

# Step 2: Pipx Configuration
print_step 2 "Pipx Configuration"
print_action "Ensuring" "pipx is properly configured" "$ICON_CONFIG"
pipx ensurepath

# Add pipx bin directory to PATH for current session
if [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
    print_action "Adding" "pipx bin directory to PATH" "$ICON_CONFIG"
    export PATH="$HOME/.local/bin:$PATH"
    print_success "PATH updated for current session"
else
    print_info "PATH already includes pipx bin directory"
fi

# Step 3: Package Installation
print_step 3 "Package Installation"

packages=({{ range $pkg := .pkgs.python.linux.pipx }}"{{ $pkg }}"{{ end }})

print_info "Installing ${#packages[@]} packages via pipx..."

# Install each package with progress tracking
for i in "${!packages[@]}"; do
    pkg="${packages[$i]}"
    print_progress $((i+1)) ${#packages[@]} "Installing: $pkg"
    pipx install "$pkg"
    if [ $? -ne 0 ]; then
        print_warning "Failed to install $pkg via pipx"
    else
        print_success "Successfully installed $pkg via pipx"
    fi
done

print_success "Pipx packages installation completed!"
print_footer "Python Pipx Package Installation" "completed"

{{- else }}
print_header "Python Pipx Package Installation" "Skipping pipx package installation" "$ICON_PYTHON"
print_warning "Pipx packages installation is disabled or no packages configured"
print_footer "Python Pipx Package Installation" "skipped"
{{- end }}
