#!/usr/bin/env bash

# Import formatting library
source "{{ .chezmoi.sourceDir }}/utils-linux/formatting.sh"

set -eufo pipefail

print_header "Cargo Package Installation" "Installing Rust crates via Cargo" "$ICON_RUST"

# Set total steps for progress tracking
set_total_steps 3

# Step 1: Check cargo availability
print_step 1 "Cargo Availability Check"
if ! command -v cargo &>/dev/null; then
  print_error "Cargo is not installed. Please install Rust first."
  print_info "Run the rust toolchain installation script first"
  print_info "Or source the cargo environment: source ~/.cargo/env"
  print_footer "Cargo Package Installation" "failed"
  exit 1
fi

# Try to source cargo environment if not in PATH but installed
if ! command -v cargo &>/dev/null && [ -f ~/.cargo/env ]; then
    print_action "Sourcing" "Cargo environment" "$ICON_CONFIG"
    source ~/.cargo/env
fi

# Final check
if ! command -v cargo &>/dev/null; then
  print_error "Cargo is not available. Rust toolchain may not be properly installed."
  print_footer "Cargo Package Installation" "failed"
  exit 1
fi

print_success "Cargo is available: $(cargo --version)"

# Step 2: Check installation preference
print_step 2 "Configuration Check"
{{- if not .installCargoPackages }}
print_info "Cargo package installation disabled via configuration"
print_info "To enable: Run 'chezmoi data set installCargoPackages true' or reconfigure with 'chezmoi init'"
print_footer "Cargo Package Installation" "skipped"
exit 0
{{- end }}

print_success "Cargo package installation enabled"

# Step 3: Package installation
print_step 3 "Package Installation"

{{- if .pkgs.cargo }}
# Collect all packages into an array
packages=()
{{- range $category, $pkgList := .pkgs.cargo }}
{{- range $pkg := $pkgList }}
packages+=("{{ $pkg }}")
{{- end }}
{{- end }}

if [ ${#packages[@]} -eq 0 ]; then
    print_info "No Cargo packages configured for installation"
    print_footer "Cargo Package Installation" "completed"
    exit 0
fi

total_packages=${#packages[@]}
print_action "Installing" "$total_packages Cargo packages" "$ICON_INSTALL"

# Display packages to be installed
print_info "Packages to install:"
for pkg in "${packages[@]}"; do
    echo "  - $pkg"
done

echo ""

# Install each package
for i in "${!packages[@]}"; do
    pkg="${packages[$i]}"
    current=$((i + 1))
    print_progress $current $total_packages "Installing: $pkg"

    if cargo install "$pkg"; then
        print_success "✓ $pkg installed successfully"
    else
        print_error "✗ Failed to install $pkg"
    fi
done

print_success "Cargo package installation completed!"
print_info "Installed packages are available in ~/.cargo/bin"
{{- else }}
print_warning "No Cargo packages configured for installation"
print_info "Add packages to home/.chezmoidata/pkgs/cargo.yml to install them"
{{- end }}

print_footer "Cargo Package Installation" "completed"
