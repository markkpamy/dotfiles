# Rust Toolchain Setup
Write-Host "=== Rust Toolchain Setup ===" -ForegroundColor Cyan

# Step 1: Check rustup availability
Write-Host "Checking rustup availability..." -ForegroundColor Yellow
if (-not (Get-Command rustup -ErrorAction SilentlyContinue)) {
    Write-Host "rustup not found. Please install via Scoop first." -ForegroundColor Red
    Write-Host "Run: scoop install rustup" -ForegroundColor Yellow
    exit 1
}

Write-Host "rustup is available" -ForegroundColor Green

# Step 2: Check if Rust is already initialized
Write-Host "Checking Rust installation..." -ForegroundColor Yellow
if (Get-Command cargo -ErrorAction SilentlyContinue) {
    Write-Host "Rust toolchain already initialized" -ForegroundColor Green
    cargo --version
    rustc --version
    Write-Host "Rust toolchain is ready" -ForegroundColor Green
    exit 0
}

# Step 3: Initialize Rust toolchain
Write-Host "Initializing Rust stable toolchain..." -ForegroundColor Yellow
rustup-init -y --default-toolchain stable --profile default

# Refresh environment to get cargo in PATH
$env:PATH = [System.Environment]::GetEnvironmentVariable("PATH", "User") + ";" + [System.Environment]::GetEnvironmentVariable("PATH", "Machine")

# Verify installation
if (Get-Command cargo -ErrorAction SilentlyContinue) {
    Write-Host "Rust toolchain initialized successfully" -ForegroundColor Green
    Write-Host "Rust compiler: $(rustc --version)" -ForegroundColor Cyan
    Write-Host "Cargo package manager: $(cargo --version)" -ForegroundColor Cyan
    Write-Host "rustup version: $(rustup --version)" -ForegroundColor Cyan
} else {
    Write-Host "Rust installation verification failed" -ForegroundColor Red
    Write-Host "You may need to restart your terminal or refresh your PATH" -ForegroundColor Yellow
    exit 1
}

Write-Host "Rust toolchain setup completed successfully!" -ForegroundColor Green
Write-Host "~/.cargo/bin has been added to your PATH" -ForegroundColor Cyan
