# AWS Helper Functions for PowerShell

function Test-AWSConfiguration {
    Write-Host "üß™ Testing AWS configuration..." -ForegroundColor Blue
    Write-Host "üìã Default profile:" -ForegroundColor Cyan
    aws sts get-caller-identity --profile default
    Write-Host "üìã Available profiles:" -ForegroundColor Cyan
    aws configure list-profiles
}

function Set-AWSProfile {
    param([string]$ProfileName)

    if (-not $ProfileName) {
        Write-Host "Current AWS profile: $($env:AWS_PROFILE ?? 'default')" -ForegroundColor Cyan
        Write-Host "Available profiles:" -ForegroundColor Cyan
        aws configure list-profiles
    } else {
        $env:AWS_PROFILE = $ProfileName
        Write-Host "‚úÖ AWS profile set to: $ProfileName" -ForegroundColor Green
        aws sts get-caller-identity
    }
}

function Invoke-AWSAssumeRole {
    param([string]$ProfileName)

    if (-not $ProfileName) {
        Write-Host "Usage: Invoke-AWSAssumeRole <profile-name>" -ForegroundColor Yellow
        return
    }

    Write-Host "üîÑ Assuming role for profile: $ProfileName" -ForegroundColor Blue
    aws sts get-caller-identity --profile $ProfileName
}

function Update-AWSConfigFromBitwarden {
    Write-Host "üîÑ Updating AWS config from Bitwarden..." -ForegroundColor Blue

    # Ensure BWS session is active
    if (-not $env:BWS_ACCESS_TOKEN) {
        Write-Host "üîê Setting up BWS session..." -ForegroundColor Yellow
        bwst
    }

    # Re-apply chezmoi templates
    Write-Host "üìù Re-applying Chezmoi templates..." -ForegroundColor Cyan
    chezmoi apply "$env:USERPROFILE\.aws\config"

    Write-Host "‚úÖ AWS config updated successfully" -ForegroundColor Green
    Write-Host "üìã Available profiles:" -ForegroundColor Cyan
    aws configure list-profiles
}

function Show-AWSProfiles {
    Write-Host "üîç AWS Profile Information:" -ForegroundColor Blue
    Write-Host "==========================" -ForegroundColor Blue

    $profiles = @(
        @{Name="nx_training_advanced"; Description="Training Advanced (EU West 3)"},
        @{Name="nx_datahub_advanced"; Description="DataHub Advanced (EU West 3)"},
        @{Name="nx_training_master"; Description="Training Master (EU West 1)"},
        @{Name="nx_profile"; Description="Training Profile (EU West 3)"},
        @{Name="nx-presales-advanced"; Description="Presales Advanced (AP Southeast 1)"},
        @{Name="nx-presales-master"; Description="Presales Master (AP Southeast 1)"},
        @{Name="nx_datahub_master"; Description="DataHub Master (EU West 3)"},
        @{Name="nx_renovation_master"; Description="Renovation Master (EU West 3)"},
        @{Name="nx_renovation_advanced"; Description="Renovation Advanced (EU West 3)"}
    )

    foreach ($profile in $profiles) {
        Write-Host ("{0,-25} {1}" -f $profile.Name, $profile.Description) -ForegroundColor White
    }

    Write-Host ""
    Write-Host "üí° Use 'aws-profile <n>' to switch profiles" -ForegroundColor Yellow
    Write-Host "üí° Use 'Update-AWSConfigFromBitwarden' to refresh from Bitwarden" -ForegroundColor Yellow
}

# Aliases for PowerShell
Set-Alias -Name aws-test -Value Test-AWSConfiguration
Set-Alias -Name aws-profile -Value Set-AWSProfile
Set-Alias -Name aws-assume -Value Invoke-AWSAssumeRole
Set-Alias -Name aws-config-update -Value Update-AWSConfigFromBitwarden
Set-Alias -Name aws-profiles -Value Show-AWSProfiles

# Quick profile aliases
function Set-AWSDevProfile { Set-AWSProfile "nx_training_advanced" }
function Set-AWSStagingProfile { Set-AWSProfile "nx_datahub_advanced" }
function Set-AWSProdProfile { Set-AWSProfile "nx_training_master" }
function Set-AWSDatahubProfile { Set-AWSProfile "nx_datahub_master" }
function Set-AWSRenovationProfile { Set-AWSProfile "nx_renovation_master" }
function Set-AWSPresalesProfile { Set-AWSProfile "nx-presales-master" }

Set-Alias -Name aws-dev -Value Set-AWSDevProfile
Set-Alias -Name aws-staging -Value Set-AWSStagingProfile
Set-Alias -Name aws-prod -Value Set-AWSProdProfile
Set-Alias -Name aws-datahub -Value Set-AWSDatahubProfile
Set-Alias -Name aws-renovation -Value Set-AWSRenovationProfile
Set-Alias -Name aws-presales -Value Set-AWSPresalesProfile
