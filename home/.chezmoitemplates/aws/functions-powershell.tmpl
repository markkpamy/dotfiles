# AWS Helper Functions for PowerShell

function Test-AWSConfiguration {
    Write-Host "üß™ Testing AWS configuration..." -ForegroundColor Blue
    Write-Host "üìã Default profile:" -ForegroundColor Cyan
    aws sts get-caller-identity --profile default
    Write-Host "üìã Available profiles:" -ForegroundColor Cyan
    aws configure list-profiles
}

function Set-AWSProfile {
    param([string]$ProfileName)

    if (-not $ProfileName) {
        Write-Host "Current AWS profile: $($env:AWS_PROFILE ?? 'default')" -ForegroundColor Cyan
        Write-Host "Available profiles:" -ForegroundColor Cyan
        aws configure list-profiles
    } else {
        $env:AWS_PROFILE = $ProfileName
        Write-Host "‚úÖ AWS profile set to: $ProfileName" -ForegroundColor Green
        aws sts get-caller-identity
    }
}

function Invoke-AWSAssumeRole {
    param([string]$ProfileName)

    if (-not $ProfileName) {
        Write-Host "Usage: Invoke-AWSAssumeRole <profile-name>" -ForegroundColor Yellow
        return
    }

    Write-Host "üîÑ Assuming role for profile: $ProfileName" -ForegroundColor Blue
    aws sts get-caller-identity --profile $ProfileName
}

function Update-AWSConfigFromBitwarden {
    Write-Host "üîÑ Updating AWS config from Bitwarden..." -ForegroundColor Blue

    # Ensure BWS session is active
    if (-not $env:BWS_ACCESS_TOKEN) {
        Write-Host "üîê Setting up BWS session..." -ForegroundColor Yellow
        bwst
    }

    # Re-apply chezmoi templates
    Write-Host "üìù Re-applying Chezmoi templates..." -ForegroundColor Cyan
    chezmoi apply "$env:USERPROFILE\.aws\config"

    Write-Host "‚úÖ AWS config updated successfully" -ForegroundColor Green
    Write-Host "üìã Available profiles:" -ForegroundColor Cyan
    aws configure list-profiles
}

function Show-AWSProfiles {
    Write-Host "üîç AWS Profile Information:" -ForegroundColor Blue
    Write-Host "==========================" -ForegroundColor Blue

    $profiles = @(
        @{Name="nx_training_advanced"; Description="Training Advanced (EU West 3)"},
        @{Name="nx_datahub_advanced"; Description="DataHub Advanced (EU West 3)"},
        @{Name="nx_training_master"; Description="Training Master (EU West 1)"},
        @{Name="nx_profile"; Description="Training Profile (EU West 3)"},
        @{Name="nx-presales-advanced"; Description="Presales Advanced (AP Southeast 1)"},
        @{Name="nx-presales-master"; Description="Presales Master (AP Southeast 1)"},
        @{Name="nx_datahub_master"; Description="DataHub Master (EU West 3)"},
        @{Name="nx_renovation_master"; Description="Renovation Master (EU West 3)"},
        @{Name="nx_renovation_advanced"; Description="Renovation Advanced (EU West 3)"}
    )

    foreach ($profile in $profiles) {
        Write-Host ("{0,-25} {1}" -f $profile.Name, $profile.Description) -ForegroundColor White
    }

    Write-Host ""
    Write-Host "üí° Use 'aws-profile <n>' to switch profiles" -ForegroundColor Yellow
    Write-Host "üí° Use 'Update-AWSConfigFromBitwarden' to refresh from Bitwarden" -ForegroundColor Yellow
}

# Aliases for PowerShell
Set-Alias -Name aws-profile -Value Set-AWSProfile
Set-Alias -Name aws-assume -Value Invoke-AWSAssumeRole
Set-Alias -Name aws-config-update -Value Update-AWSConfigFromBitwarden
Set-Alias -Name aws-profiles -Value Show-AWSProfiles

Set-Alias -Name aws-dev -Value Set-AWSDevProfile
Set-Alias -Name aws-staging -Value Set-AWSStagingProfile
Set-Alias -Name aws-prod -Value Set-AWSProdProfile
Set-Alias -Name aws-datahub -Value Set-AWSDatahubProfile
Set-Alias -Name aws-renovation -Value Set-AWSRenovationProfile
Set-Alias -Name aws-presales -Value Set-AWSPresalesProfile
" -ForegroundColor Red
        Write-Host "üí° Run 'Update-AWSConfigFromBitwarden' to generate from Bitwarden" -ForegroundColor Yellow
        return
    }

    Write-Host "üìã Available Profiles:" -ForegroundColor Cyan
    Write-Host "----------------------" -ForegroundColor Cyan

    # Get all profiles using AWS CLI and add region information
    $profiles = aws configure list-profiles
    foreach ($profile in $profiles) {
        try {
            $region = aws configure get region --profile $profile 2>$null
            if (-not $region) { $region = "(region not set)" }

            # Show role info if it's a role-based profile
            $roleArn = aws configure get role_arn --profile $profile 2>$null

            if ($roleArn) {
                # Extract account ID from role ARN for display
                $accountId = $roleArn -replace '.*::(\d+):.*', '$1'
                Write-Host ("{0,-25} {1,-15} (Role: {2})" -f $profile, $region, $accountId) -ForegroundColor White
            } else {
                Write-Host ("{0,-25} {1,-15} (Base credentials)" -f $profile, $region) -ForegroundColor White
            }
        }
        catch {
            Write-Host ("{0,-25} (Error reading config)" -f $profile) -ForegroundColor Yellow
        }
    }

    Write-Host ""
    Write-Host "üí° Use 'aws-profile <n>' to switch profiles" -ForegroundColor Yellow
    Write-Host "üí° Use 'Update-AWSConfigFromBitwarden' to refresh from Bitwarden" -ForegroundColor Yellow
    Write-Host "üí° Current profile: $($env:AWS_PROFILE ?? 'default')" -ForegroundColor Yellow

    # Show current identity
    Write-Host ""
    Write-Host "üîë Current Identity:" -ForegroundColor Cyan
    Write-Host "-------------------" -ForegroundColor Cyan
    try {
        aws sts get-caller-identity --output table | Out-Host
        Write-Host "‚úÖ Successfully authenticated" -ForegroundColor Green
    }
    catch {
        Write-Host "‚ùå Not authenticated or session expired" -ForegroundColor Red
        Write-Host "üí° Ensure BWS session is active: bwst" -ForegroundColor Yellow
    }
}

# Aliases for PowerShell
Set-Alias -Name aws-profile -Value Set-AWSProfile
Set-Alias -Name aws-assume -Value Invoke-AWSAssumeRole
Set-Alias -Name aws-config-update -Value Update-AWSConfigFromBitwarden
Set-Alias -Name aws-profiles -Value Show-AWSProfiles
