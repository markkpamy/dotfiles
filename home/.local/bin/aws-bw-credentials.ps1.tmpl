# AWS Credential Process Script for Windows PowerShell
# This script fetches AWS credentials from Bitwarden for the default profile

param(
    [string]$Profile = "default"
)

$ErrorActionPreference = "Stop"

try {
{{- if .aws.use_bws }}
    # Using Bitwarden Secrets Manager (BWS)
    if (-not $env:BWS_ACCESS_TOKEN) {
        Write-Error "BWS_ACCESS_TOKEN environment variable not set. Please run: bwst"
        exit 1
    }

    $accessKeyResult = bws secret get "aws-default-access-key-id" --access-token $env:BWS_ACCESS_TOKEN --output json | ConvertFrom-Json
    $secretKeyResult = bws secret get "aws-default-secret-access-key" --access-token $env:BWS_ACCESS_TOKEN --output json | ConvertFrom-Json

    $accessKey = $accessKeyResult.value
    $secretKey = $secretKeyResult.value

{{- else }}
    # Using traditional Bitwarden CLI (BW)
    if (-not $env:BW_SESSION) {
        Write-Error "BW_SESSION environment variable not set. Please run: `$env:BW_SESSION = bw unlock --raw"
        exit 1
    }

    $accessKey = bw get username "{{ .bitwarden.aws.item_name | default "AWS Default Profile" }}" --session $env:BW_SESSION
    $secretKey = bw get password "{{ .bitwarden.aws.item_name | default "AWS Default Profile" }}" --session $env:BW_SESSION
{{- end }}

    if (-not $accessKey -or -not $secretKey) {
        Write-Error "Failed to retrieve AWS credentials from Bitwarden"
        exit 1
    }

    $credential = @{
        Version = 1
        AccessKeyId = $accessKey
        SecretAccessKey = $secretKey
    }

    $credential | ConvertTo-Json -Compress
}
catch {
    Write-Error "Error retrieving AWS credentials: $($_.Exception.Message)"
    exit 1
}
