#!/usr/bin/env bash
# AWS Credential Process Script
# Usage: aws-bw-credentials <bw-item-name>

set -euo pipefail

BW_ITEM_NAME="${1}"

if [ -z "$BW_ITEM_NAME" ]; then
    echo "Error: BW item name required as first argument" >&2
    echo "Usage: aws-bw-credentials <bw-item-name>" >&2
    exit 1
fi

# Check for Bitwarden session
if [ -z "${BW_SESSION:-}" ]; then
    echo "Error: BW_SESSION environment variable not set" >&2
    echo "Please run: export BW_SESSION=\$(bw unlock --raw)" >&2
    exit 1
fi

# Fetch credentials using BW CLI
ACCESS_KEY=$(bw get username "$BW_ITEM_NAME" --session "$BW_SESSION" 2>/dev/null)
SECRET_KEY=$(bw get password "$BW_ITEM_NAME" --session "$BW_SESSION" 2>/dev/null)

# Validate credentials were retrieved
if [ -z "$ACCESS_KEY" ] || [ -z "$SECRET_KEY" ]; then
    echo "Error: Failed to retrieve AWS credentials from Bitwarden item: $BW_ITEM_NAME" >&2
    exit 1
fi

# Output in AWS credential_process format
cat << EOF
{
  "Version": 1,
  "AccessKeyId": "$ACCESS_KEY",
  "SecretAccessKey": "$SECRET_KEY"
}
EOF
